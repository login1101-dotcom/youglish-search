<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Youglish-like Vowel Normalizer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { font-size: 20px; }
    .ipa { font-size: 24px; margin: 10px 0; }
    .red { color: red; font-weight: bold; }
    .section { margin-top: 20px; }
    button { margin-left: 10px; }
  </style>
</head>
<body>
  <h1>Youglish-like Vowel Normalizer</h1>
  <input id="wordInput" type="text" placeholder="単語を入力">
  <button onclick="lookup()">検索</button>

  <div id="result"></div>

  <script>
    // ---- 1. 母音マップ（あなたの指定通り） ----
    const VOWEL_MAP = [
      // r系
      {regex:/ɑːr|ɑr|ɑː/g, cat:'ar_sound', symbol:'ɑːr'},
      {regex:/ɔːr|ɔr|ɔː/g, cat:'or_sound', symbol:'ɔːr'},
      {regex:/ɝː|ɝ|ɚ|ɜː/g, cat:'er_sound', symbol:'ɝː'},
      // 二重母音
      {regex:/eɪ/g, cat:'long_a', symbol:'eɪ'},
      {regex:/oʊ|əʊ/g, cat:'long_o', symbol:'oʊ'},
      {regex:/aɪ/g, cat:'long_i', symbol:'aɪ'},
      {regex:/aʊ/g, cat:'ow_sound', symbol:'aʊ'},
      {regex:/ɔɪ/g, cat:'oi_sound', symbol:'ɔɪ'},
      // 単母音
      {regex:/æ/g, cat:'short_a', symbol:'æ'},
      {regex:/e|ɛ/g, cat:'short_e', symbol:'e'},
      {regex:/ɪ|i/g, cat:'short_i', symbol:'ɪ'},
      {regex:/ɑ|ɒ/g, cat:'short_o', symbol:'ɑ'},
      {regex:/ʌ/g, cat:'short_u', symbol:'ʌ'},
      {regex:/ʊ/g, cat:'short_oo', symbol:'ʊ'},
      {regex:/iː/g, cat:'long_e', symbol:'iː'},
      {regex:/uː/g, cat:'long_oo', symbol:'uː'},
      {regex:/ə/g, cat:'schwa', symbol:'ə'},
    ];

    // ---- 2. 辞書APIからIPAを取得 ----
    async function fetchIPA(word){
      try {
        const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${word}`;
        const res = await fetch(url);
        if(!res.ok) return null;
        const data = await res.json();
        // IPA抽出
        let phonetic = "";
        for(const entry of data){
          if(entry.phonetics){
            const ipaObj = entry.phonetics.find(p=>p.text);
            if(ipaObj){ phonetic = ipaObj.text; break; }
          }
        }
        return phonetic || null;
      } catch(e){
        console.error(e);
        return null;
      }
    }

    // ---- 3. ストレス記号削除 ----
    function stripStress(ipa){
      return ipa.replace(/[ˈˌ]/g,"");
    }

    // ---- 4. 赤ハイライト（辞書IPAそのまま） ----
    function highlightVowels(ipa){
      let out = ipa;
      // 長いもの優先（複合→単体）
      const patterns = [
        "ɑːr","ɑr","ɔːr","ɔr","ɝː","ɝ","ɚ","ɜː","eɪ","oʊ","əʊ","aɪ","aʊ","ɔɪ",
        "iː","uː","ɑː","ɒ","ɑ","ɔ","æ","e","ɛ","ɪ","ʊ","ʌ","ə","i","u"
      ];
      for(const p of patterns){
        const re = new RegExp(p,"g");
        out = out.replace(re, m=>`<span class="red">${m}</span>`);
      }
      return out;
    }

    // ---- 5. 正規化処理 ----
    function normalizeIPA(ipa){
      const ipaCore = stripStress(ipa).normalize("NFC");
      let matches = [];
      for(const m of VOWEL_MAP){
        const found = ipaCore.match(m.regex);
        if(found){ for(const f of found){ matches.push({cat:m.cat,symbol:m.symbol}); } }
      }
      return matches;
    }

    // ---- 6. 検索処理 ----
    async function lookup(){
      const word = document.getElementById("wordInput").value.trim().toLowerCase();
      if(!word) return;
      document.getElementById("result").innerHTML = "検索中...";

      const ipa = await fetchIPA(word);
      if(!ipa){
        document.getElementById("result").innerHTML = "辞書IPAが見つかりません";
        return;
      }

      const norm = normalizeIPA(ipa);

      let html = `<div class="section"><b>単語:</b> ${word}</div>`;
      html += `<div class="section"><b>辞書IPA:</b> <span class="ipa">${highlightVowels(ipa)}</span></div>`;
      html += `<div class="section"><b>発音記号（正規化）:</b> `;
      if(norm.length){
        html += norm.map(n=>`<span class="ipa red">${n.symbol}</span>`).join(" ");
      }else{
        html += "(該当なし)";
      }
      html += `</div>`;

      document.getElementById("result").innerHTML = html;
    }
  </script>
</body>
</html>
