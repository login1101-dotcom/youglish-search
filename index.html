<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>母音抽出＋例語再生（USのみ・ローカル音源）</title>
<style>
  :root{
    --bg:#f7f7fb; --card:#ffffff; --ink:#222; --muted:#666; --line:#e7e7ef; --accent:#2563eb;
    --red:#e11d48;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Yu Gothic UI", "YuGothic", "Meiryo", "Noto Sans JP", sans-serif;}
  .wrap{max-width:960px;margin:32px auto;padding:0 16px;}
  h1{font-size:22px;margin:0 0 12px;}
  .bar{background:#fff7d6;border:1px solid #ffe9a6;padding:12px 16px;border-radius:10px;margin-bottom:16px}
  .row{display:flex;gap:8px;align-items:center}
  input[type="text"]{flex:1;padding:12px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px;background:#fff;}
  button{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:600}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin:14px 0}
  .title{font-weight:700;margin-bottom:8px}
  .muted{color:var(--muted);font-size:12px}
  .ipa{font-size:28px;letter-spacing:1px;margin:12px 0}
  .ipa .vred{color:var(--red);font-weight:800}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;margin:6px 6px 0 0;background:#fff}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:14px;padding:6px 10px;margin:6px 6px 0 0;background:#fff}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
  .tiny{font-size:12px}
  .audrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .audrow audio{width:240px;max-width:100%}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
</style>
</head>
<body>
<div class="wrap">

  <div class="bar">
    <h1>母音抽出＋例語再生（USのみ・ローカル音源）</h1>
    <div class="row">
      <input id="q" type="text" placeholder="単語を入力（例: dog, cat, bird, car, boy, centrifuge ...）" />
      <button id="go" class="primary">検索</button>
      <button id="yg">YouGlishで開く</button>
    </div>
  </div>

  <!-- 辞書 IPA -->
  <div class="card" id="secDict">
    <div class="title">辞書（IPA）</div>
    <div class="ipa" id="ipaDict">—</div>
    <div class="audrow">
      <button id="dictSpeak" class="pill">辞書音声</button>
      <a id="wikilink" class="pill" href="#" target="_blank" rel="noopener">Wiktionary</a>
    </div>
    <div class="muted tiny">※ 取得元: dictionaryapi.dev（US） / 「辞書音声」ボタンは辞書の音声を再生</div>
    <audio id="dictAudio" preload="none"></audio>
  </div>

  <!-- 正規化＆赤強調 -->
  <div class="card" id="secNorm">
    <div class="title">発音記号（17母音に正規化＆赤色強調）</div>
    <div class="ipa" id="ipaNorm">—</div>
    <div class="muted tiny">※ 取得IPAから母音コア（ae, o, ɑ, ɔ, ɝ, ɑːr, ɔːr, e, ɪ, iː, uː, ʊ, oʊ, aɪ, aʊ, ɔɪ, ə など）だけ抽出し、指定17カテゴリへマッピング。赤強調。</div>
  </div>

  <!-- 含まれるカテゴリのみ -->
  <div class="card" id="secCats">
    <div class="title">母音カテゴリ（この単語に含まれるもののみ）</div>
    <div id="cats"></div>
  </div>

  <!-- 例単語（ローカル再生） -->
  <div class="card" id="secEx">
    <div class="title">例単語（クリックでローカル音声再生）</div>
    <div id="examples"></div>
    <div class="hint">ローカル音声フォルダ:  ~/youglish-search/audio/vowels/*.mp3 、 ~/youglish-search/audio/words/*.mp3</div>
  </div>

</div>

<script>
/* ========================
   設定：ローカル音源パス
======================== */
const VOWEL_BASE = './audio/vowels/'; // 例: ~/youglish-search/audio/vowels/ に commit 済
const WORD_BASE  = './audio/words/';  // 例: ~/youglish-search/audio/words/ に commit 済

/* ========================
   17母音 定義（正規化・表示・音源・例語）
   ※ 複合 > 単音 の順に並べる（抽出順に影響）
======================== */
const VOWELS = [
  // r付き複合
  {id:'ar_sound',  label:'ar sound',  cores:['ɑːr','ɑr'],   display:'ɑːr', file:'ar_sound.mp3',
   words:['car','park','arm']},
  {id:'or_sound',  label:'or sound',  cores:['ɔːr'],        display:'ɔːr', file:'or_sound.mp3',
   words:['or','sort','storm']},
  {id:'er_sound',  label:'er sound',  cores:['ɝː','ɝ','ɚ'], display:'ɝː', file:'er_sound.mp3',
   words:['bird','herd','hurt']},

  // 二重母音
  {id:'oi_sound',  label:'oi sound',  cores:['ɔɪ'],         display:'ɔɪ',  file:'oi_sound.mp3',
   words:['boy','join','voice']},
  {id:'ow_sound',  label:'ow sound',  cores:['aʊ'],         display:'aʊ',  file:'ow_sound.mp3',
   words:['out','now','cow']},
  {id:'long_i',    label:'long i',    cores:['aɪ'],         display:'aɪ',  file:'long_i.mp3',
   words:['time','line','light']},
  {id:'long_o',    label:'long o',    cores:['oʊ'],         display:'oʊ',  file:'long_o.mp3',
   words:['note','no','slow']},

  // 長短・単母音
  {id:'long_e',    label:'long e',    cores:['iː'],         display:'iː',  file:'long_e.mp3',
   words:['see','eat','need']},
  {id:'short_i',   label:'short i',   cores:['ɪ'],          display:'ɪ',   file:'short_i.mp3',
   words:['fit','it','income']},
  {id:'long_oo',   label:'long oo',   cores:['uː'],         display:'uː',  file:'long_oo.mp3',
   words:['too','food','zoo']},
  {id:'short_oo',  label:'short oo',  cores:['ʊ'],          display:'ʊ',   file:'short_oo.mp3',
   words:['book','look','put']},
  {id:'aw_sound',  label:'aw sound',  cores:['ɔː','ɔ'],     display:'ɔ',   file:'ow_sound.mp3',
   words:['law','caught','thought']},
  {id:'short_o',   label:'short o',   cores:['ɑ'],          display:'ɑ',   file:'short_o.mp3',
   words:['hot','not','lock']},
  {id:'short_a',   label:'short a',   cores:['æ'],          display:'æ',   file:'short_a.mp3',
   words:['cat','camp','bath']},
  {id:'short_e',   label:'short e',   cores:['e'],          display:'e',   file:'short_e.mp3',
   words:['get','pen','bed']},
  {id:'schwa',     label:'schwa',     cores:['ə'],          display:'ə',   file:'schwa.mp3',
   words:['about','pencil','support']},
];

/* 抽出に使う正規表現（複合→単音の順で連結） */
const VOWEL_CORE_RE =
  new RegExp(
    '(' + VOWELS.flatMap(v => v.cores.sort((a,b)=>b.length-a.length)).join('|') + ')',
    'g'
  );

/* IPAから強勢記号を除去 */
const stripStress = s => (s||'').replace(/[ˈˌ]/g,'');

/* IPA文字列を走査して「含まれる全コア配列」を返す */
function extractCores(ipaText){
  if(!ipaText) return [];
  const clean = stripStress(ipaText).normalize('NFC');
  const found = clean.match(VOWEL_CORE_RE) || [];
  return found;
}

/* 見つかったコアを 17母音カテゴリへ（重複は1回） */
function coresToCats(cores){
  const cats = [];
  const seen = new Set();
  cores.forEach(tok=>{
    for(const v of VOWELS){
      if(v.cores.includes(tok)){
        if(!seen.has(v.id)){ seen.add(v.id); cats.push(v); }
        break;
      }
    }
  });
  return cats;
}

/* 表示用：元のIPAを「コアだけ赤」でハイライト */
function highlightIPA(ipaText){
  if(!ipaText) return '—';
  const clean = ipaText.normalize('NFC');
  return clean.replace(VOWEL_CORE_RE, m=>`<span class="vred">${m}</span>`);
}

/* 正規化表示：元IPAの順番で、該当カテゴリの「正規化記号」に置換＆赤 */
function normalizedIPA(ipaText){
  if(!ipaText) return '—';
  let out = stripStress(ipaText).normalize('NFC');
  // 長いコアから順に、正規化記号にすり替え
  const pairs = [];
  VOWELS.forEach(v=>{
    v.cores
     .sort((a,b)=>b.length-a.length)
     .forEach(c=>pairs.push([c, v.display]));
  });
  for(const [raw, disp] of pairs){
    const re = new RegExp(raw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'g');
    out = out.replace(re, disp);
  }
  // 最後にコア部を赤化（display 記号を対象）
  const dispRe = new RegExp('(' + VOWELS.map(v=>v.display).sort((a,b)=>b.length-a.length).join('|') + ')','g');
  return out.replace(dispRe, m=>`<span class="vred">${m}</span>`);
}

/* 例単語のカード群（この単語に含まれるカテゴリのみ表示） */
function renderExamples(cats){
  const holder = document.getElementById('examples');
  holder.innerHTML = '';
  if(!cats.length){ holder.innerHTML = '<div class="muted">例単語は表示できません。</div>'; return; }

  const frag = document.createDocumentFragment();
  cats.forEach(v=>{
    const card = document.createElement('div');
    card.className = 'card';
    const h = document.createElement('div');
    h.className = 'title';
    h.textContent = v.label + ' /' + v.display + '/';
    const aud = document.createElement('audio');
    aud.controls = true;
    aud.preload = 'none';
    aud.src = VOWEL_BASE + (v.file || '');
    const row = document.createElement('div');
    row.className = 'audrow';
    row.appendChild(aud);

    // 例単語ボタン＋各 audio
    const wordsRow = document.createElement('div');
    wordsRow.className = 'audrow';
    v.words.forEach(w=>{
      const pill = document.createElement('button');
      pill.className = 'pill';
      pill.textContent = w;
      pill.addEventListener('click', ()=>{
        const a = new Audio(WORD_BASE + w + '.mp3');
        a.play().catch(err=>{
          alert('音声を再生できませんでした。ローカル音源はブラウザ制約でブロックされることがあります。');
          console.error(err);
        });
      });
      wordsRow.appendChild(pill);
    });

    card.appendChild(h);
    card.appendChild(row);
    card.appendChild(wordsRow);
    frag.appendChild(card);
  });
  holder.appendChild(frag);
}

/* カテゴリ一覧（この単語に含まれるものだけ＋各カテゴリの母音再生ボタン） */
function renderCats(cats){
  const wrap = document.getElementById('cats');
  wrap.innerHTML = '';
  if(!cats.length){ wrap.innerHTML = '<div class="muted">母音カテゴリは検出できませんでした。</div>'; return; }

  const row = document.createElement('div');
  row.className = 'audrow';
  cats.forEach(v=>{
    const b = document.createElement('div');
    b.className = 'badge';
    const play = document.createElement('button');
    play.textContent = '再生';
    play.addEventListener('click', ()=>{
      const a = new Audio(VOWEL_BASE + (v.file||''));
      a.play().catch(err=>{
        alert('音声を再生できませんでした。ローカル音源はブラウザ制約でブロックされることがあります。');
        console.error(err);
      });
    });
    const lab = document.createElement('span');
    lab.textContent = `${v.label} /${v.display}/`;
    b.appendChild(play);
    b.appendChild(lab);
    row.appendChild(b);
  });
  wrap.appendChild(row);
}

/* ==============
   外部辞書取得
================= */
async function fetchIPA(word){
  const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('dictionaryapi.dev error');
  const data = await res.json();
  // US を優先して IPA と audio
  let ipa = '';
  let audio = '';
  for(const entry of data){
    const phs = entry?.phonetics || [];
    // US 音声がある行を優先
    const us = phs.find(p=>(p?.audio||'').includes('-us.mp3')) || phs.find(p=>p.audio) || null;
    if(!ipa){
      ipa = (us?.text || phs.find(p=>p.text)?.text || '').trim();
    }
    if(!audio){
      audio = (us?.audio || phs.find(p=>p.audio)?.audio || '').trim();
    }
    if(ipa && audio) break;
  }
  return {ipa, audio};
}

/* ==============
   メイン処理
================= */
async function run(){
  const word = (document.getElementById('q').value||'').trim();
  if(!word) return;

  // 初期化
  document.getElementById('ipaDict').innerHTML = '—';
  document.getElementById('ipaNorm').innerHTML = '—';
  document.getElementById('cats').innerHTML = '';
  document.getElementById('examples').innerHTML = '';
  document.getElementById('wikilink').href = `https://en.wiktionary.org/wiki/${encodeURIComponent(word)}`;

  // 取得
  let ipa = '';
  let audio = '';
  try{
    const out = await fetchIPA(word);
    ipa = out.ipa || '';
    audio = out.audio || '';
  }catch(e){
    console.error(e);
  }

  // 1) 辞書IPA（母音コア赤強調）
  const ipaShown = ipa || '—';
  document.getElementById('ipaDict').innerHTML = highlightIPA(ipaShown);

  // 2) 正規化＆赤強調表示
  if(ipa){
    document.getElementById('ipaNorm').innerHTML = normalizedIPA(ipa);
  }else{
    document.getElementById('ipaNorm').innerHTML = '—';
  }

  // 3) 含まれるカテゴリ（この単語に含まれるものだけ）
  const cores = extractCores(ipa);
  const cats = coresToCats(cores);
  renderCats(cats);

  // 4) 例単語（上で出たカテゴリだけを表示）
  renderExamples(cats);

  // 5) 辞書音声ボタン
  const dictBtn = document.getElementById('dictSpeak');
  const dictAud = document.getElementById('dictAudio');
  dictAud.src = audio || '';
  dictBtn.disabled = !audio;
  dictBtn.onclick = ()=>{
    if(!dictAud.src){ return; }
    dictAud.play().catch(err=>{
      alert('音声を再生できませんでした。ローカル音源はブラウザ制約でブロックされることがあります。');
      console.error(err);
    });
  };
}

/* YouGlish ボタン */
document.getElementById('yg').onclick = ()=>{
  const w = (document.getElementById('q').value||'').trim();
  if(!w) return;
  window.open(`https://youglish.com/pronounce/${encodeURIComponent(w)}/english/us`, '_blank');
};

/* イベント */
document.getElementById('go').addEventListener('click', run);
document.getElementById('q').addEventListener('keydown', e=>{
  if(e.key==='Enter') run();
});

/* 初期フォーカス */
document.getElementById('q').focus();
</script>
</body>
</html>
