<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Youglish Search</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .ipa { font-size: 20px; margin: 10px 0; }
    .highlight { color: red; font-weight: bold; }
    .section { margin-top: 20px; }
    audio { margin-top: 5px; display: block; }
  </style>
</head>
<body>
  <h1>Youglish-like IPA Search</h1>
  <input id="wordInput" type="text" placeholder="Enter a word" />
  <button onclick="searchWord()">Search</button>

  <div class="section">
    <h2>辞書IPA</h2>
    <div id="dictIPA"></div>
  </div>

  <div class="section">
    <h2>発音記号（正規化）</h2>
    <div id="normIPA"></div>
  </div>

  <div class="section">
    <h2>母音カテゴリ</h2>
    <div id="vowelCategory"></div>
    <div id="vowelAudio"></div>
  </div>

  <div class="section">
    <h2>例単語</h2>
    <div id="examples"></div>
  </div>

<script>
// stress 記号除去
function stripStress(ipaText) {
  return ipaText.replace(/[ˈˌ]/g, '');
}

// 17母音対応 正規化マップ
function normalizeVowel(core) {
  switch (core) {
    case 'æ': return {cat:'short_a', symbol:'æ'};
    case 'ɑ': return {cat:'short_o', symbol:'ɑ'};
    case 'e': return {cat:'short_e', symbol:'e'};
    case 'ɪ': return {cat:'short_i', symbol:'ɪ'};
    case 'iː': return {cat:'long_e', symbol:'iː'};
    case 'ʊ': return {cat:'short_oo', symbol:'ʊ'};
    case 'uː': return {cat:'long_oo', symbol:'uː'};
    case 'oʊ': return {cat:'long_o', symbol:'oʊ'};
    case 'aɪ': return {cat:'long_i', symbol:'aɪ'};
    case 'aʊ': return {cat:'ow_sound', symbol:'aʊ'};
    case 'ɔɪ': return {cat:'oi_sound', symbol:'ɔɪ'};
    case 'ɝː': case 'ɝ': return {cat:'er_sound', symbol:'ɝː'};
    case 'ɔː': case 'ɔ': return {cat:'aw_sound', symbol:'ɔ'};
    case 'ɑːr': case 'ɑr': return {cat:'ar_sound', symbol:'ɑːr'};
    default: return null;
  }
}

// 母音抽出（複合優先）
function extractVowels(ipaText) {
  const ipaCore = stripStress(ipaText).normalize('NFC');
  const VOWEL_CORE_RE = /(ɑːr|ɑr|ɝː|ɝ|ɔː|ɔ|ɑ|æ|e|iː|ɪ|uː|ʊ|oʊ|aɪ|aʊ|ɔɪ)/g;
  return ipaCore.match(VOWEL_CORE_RE) || [];
}

// データ定義（例単語）
const VOWEL_DATA = {
  short_a: { ex:['cat','camp','bath'], audio:'audio/vowels/short_a.mp3' },
  short_o: { ex:['dog','not','hot'],   audio:'audio/vowels/short_o.mp3' },
  short_e: { ex:['bed','pen','red'],   audio:'audio/vowels/short_e.mp3' },
  short_i: { ex:['sit','hit','fish'],  audio:'audio/vowels/short_i.mp3' },
  long_e:  { ex:['see','green','believe'], audio:'audio/vowels/long_e.mp3' },
  short_oo:{ ex:['book','good','put'], audio:'audio/vowels/short_oo.mp3' },
  long_oo: { ex:['food','loose','through'], audio:'audio/vowels/long_oo.mp3' },
  long_o:  { ex:['go','home','open'],  audio:'audio/vowels/long_o.mp3' },
  long_i:  { ex:['time','find','like'], audio:'audio/vowels/long_i.mp3' },
  ow_sound:{ ex:['now','out','down'],  audio:'audio/vowels/ow_sound.mp3' },
  oi_sound:{ ex:['boy','coin','voice'], audio:'audio/vowels/oi_sound.mp3' },
  er_sound:{ ex:['bird','hurt','learn'], audio:'audio/vowels/er_sound.mp3' },
  aw_sound:{ ex:['caught','dog','law'], audio:'audio/vowels/aw_sound.mp3' },
  ar_sound:{ ex:['car','art','mark'],  audio:'audio/vowels/ar_sound.mp3' }
};

// 検索処理
async function searchWord() {
  const word = document.getElementById("wordInput").value.trim();
  if (!word) return;

  const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
  const data = await res.json();
  if (!Array.isArray(data)) { alert("Word not found"); return; }

  const phonetic = data[0].phonetics.find(p=>p.text)?.text || "";
  document.getElementById("dictIPA").innerHTML = phonetic;

  const vowels = extractVowels(phonetic);
  let normList = [];
  let cats = [];
  vowels.forEach(v=>{
    const norm = normalizeVowel(v);
    if (norm) {
      normList.push(`<span class="highlight">${norm.symbol}</span>`);
      cats.push(norm.cat);
    }
  });
  document.getElementById("normIPA").innerHTML = normList.join(" ");

  // 母音カテゴリ表示（重複除去）
  cats = [...new Set(cats)];
  const catDiv = document.getElementById("vowelCategory");
  const audioDiv = document.getElementById("vowelAudio");
  const exDiv = document.getElementById("examples");
  catDiv.innerHTML = ""; audioDiv.innerHTML=""; exDiv.innerHTML="";

  cats.forEach(c=>{
    if (VOWEL_DATA[c]) {
      catDiv.innerHTML += `<p>${c}</p>`;
      audioDiv.innerHTML += `<audio controls src="${VOWEL_DATA[c].audio}"></audio>`;
      VOWEL_DATA[c].ex.forEach(ex=>{
        exDiv.innerHTML += `<p>${ex}<br/><audio controls src="audio/words/${ex}.mp3"></audio></p>`;
      });
    }
  });
}
</script>
</body>
</html>
