<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- キャッシュ無効化（1回で更新反映） -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<script>
  (function(){ const u=new URL(location.href); if(!u.searchParams.has('v')){ u.searchParams.set('v', Date.now().toString()); location.replace(u.toString()); }})();
</script>

<title>母音抽出＋例語再生（US基準・三段ソース：MW / Wiktionary / dictionaryapi.dev）</title>
<style>
  :root{ --bg:#fafafa; --card:#fff; --ink:#222; --muted:#666; --accent:#0b74ff; --chip:#eef4ff; --red:#d9002b; --border:#e7e7e7; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans CJK JP",sans-serif}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  header{background:#fff;position:sticky;top:0;border-bottom:1px solid var(--border);z-index:10}
  h1{font-size:20px;margin:0;padding:14px 16px}
  .srch{display:flex;gap:8px;flex-wrap:wrap; margin:12px 0 24px}
  .srch input{flex:1;min-width:220px;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:16px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .sec{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 14px;margin:16px 0}
  .row{display:flex;align-items:flex-start;gap:16px;flex-wrap:wrap}
  .col{flex:1;min-width:260px}
  .ipa{font-family:"Noto Serif","Times New Roman",serif; font-size:22px; letter-spacing:.5px}
  .ipa .vwl{color:var(--red);font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:var(--chip);border:1px solid #dfeaff}
  .chip .small{font-size:12px;color:var(--muted)}
  .cat-head{display:flex;align-items:center;gap:10px; font-weight:700}
  .cat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .pill{display:inline-grid;grid-auto-flow:column;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
  audio{height:32px;width:100%}
  .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f7f7f7;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  .src{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tag{font-size:12px;border:1px solid var(--border);padding:2px 6px;border-radius:999px;background:#fff}
</style>
</head>
<body>
<header><h1>母音抽出＋例語再生（US基準・三段ソース統合）</h1></header>
<div class="wrap">
  <!-- 検索窓 -->
  <div class="srch">
    <input id="q" placeholder="単語（例: bear, wear, pear, fairy, are, car ...）" />
    <button class="btn primary" id="btn" type="button">検索</button>
    <button class="btn" id="yg" type="button">YouGlishで開く</button>
  </div>

  <!-- 辞書IPA（左・採用候補＋ソース表示） + 正規化IPA（右・17母音） -->
  <section class="sec" id="sec-ipa-norm">
    <div class="row">
      <div class="col">
        <div class="muted">辞書（採用IPA / ソース優先: Merriam-Webster → Wiktionary → dictionaryapi.dev）</div>
        <div id="ipaDict" class="ipa">—</div>
        <div class="src" style="margin-top:8px">
          <span class="muted">※ 参照:</span>
          <span id="srcTags" class="src"></span>
          <span class="muted" id="wikilink"></span>
        </div>
        <div style="margin-top:8px">
          <button class="btn" id="playDict" type="button">辞書音声</button>
          <audio id="dictAudio" preload="none"></audio>
        </div>
      </div>
      <div class="col">
        <div class="muted">正規化発音記号（17母音 &amp; 赤色強調）</div>
        <div id="ipaNorm" class="ipa">—</div>
      </div>
    </div>
  </section>

  <section class="sec" id="sec-cats">
    <div class="muted">母音カテゴリ（この単語に含まれるもののみ）</div>
    <div id="catList" class="cat-grid"></div>
  </section>

  <section class="sec" id="sec-ex">
    <div class="muted">例単語（クリックでローカル音声再生）</div>
    <div id="examples" class="cat-grid"></div>
    <div class="muted" style="margin-top:8px">
      ローカル音声フォルダ: <span class="code">./audio/vowels/*.mp3</span> , <span class="code">./audio/words/*.mp3</span>
    </div>
  </section>
</div>

<script>
/* ===================== 17母音仕様 ===================== */
const CATEGORY_ORDER = [
  "short i","long e","short e","short a","long a",
  "short oo","long u","short o","long o",
  "ar sound","or sound","er sound",
  "ai sound","au sound","oi sound",
  "schwa","schwa+r"
];

const CATEGORY_LABELS = {
  "short i":"ɪ","long e":"iː","short e":"ɛ","short a":"æ","long a":"eɪ",
  "short oo":"ʊ","long u":"uː","short o":"ɑ","long o":"oʊ",
  "ar sound":"ɑːr","or sound":"ɔːr","er sound":"ɝː",
  "ai sound":"aɪ","au sound":"aʊ","oi sound":"ɔɪ","schwa":"ə","schwa+r":"ɚ"
};

const CATEGORY_AUDIO = {
  "short i":"short_i.mp3","long e":"long_e.mp3","short e":"short_e.mp3",
  "short a":"short_a.mp3","long a":"long_a.mp3","short oo":"short_oo.mp3",
  "long u":"long_oo.mp3","short o":"short_o.mp3","long o":"long_o.mp3",
  "ar sound":"ar_sound.mp3","or sound":"or_sound.mp3","er sound":"er_sound.mp3",
  "ai sound":"long_i.mp3","au sound":"ow_sound.mp3","oi sound":"oi_sound.mp3",
  "schwa":"schwa.mp3","schwa+r":"schwa_r.mp3"
};

const CATEGORY_EXAMPLES = {
  "short i":["is","fit","it"], "long e":["she","believe"], "short e":["let","get","pencil"],
  "short a":["cat","camp","bath","fan"], "long a":["fate","great"], "short oo":["put"],
  "long u":["too","loose"], "short o":["hot","not","lock","on","dog"], "long o":["no","note","slow"],
  "ar sound":["are","car","mark","art"], "or sound":["caught","storm","sort","law"],
  "er sound":["hurt","term","bird"], "ai sound":["eye","iron"], "au sound":["out","house"],
  "oi sound":["join","joy"], "schwa":["about","support"], "schwa+r":["color","teacher"]
};

/* ===== 正規化マップ（新旧・米英 → US基準） ===== */
const IPA_TO_CATEGORY = {
  "ɑr":"ar sound","ɑːr":"ar sound","ɑɹ":"ar sound","ɑːɹ":"ar sound",
  "ɔr":"or sound","ɔːr":"or sound","ɔɹ":"or sound","ɔːɹ":"or sound",
  "ɝ":"er sound","ɝː":"er sound","ɚ":"er sound","ɜː":"er sound",
  "ɪ":"short i","i":"long e","iː":"long e","ɛ":"short e","æ":"short a",
  "eɪ":"long a","ʊ":"short oo","u":"long u","uː":"long u",
  "ɑ":"short o","ɒ":"short o","ɔ":"short o",
  "oʊ":"long o","əʊ":"long o",
  "aɪ":"ai sound","aʊ":"au sound","ɔɪ":"oi sound",
  "ə":"schwa"
};

/* r直結・中心化二重母音の分解（US想定） */
const SPECIAL_SPLIT = {
  "iə":["short i","er sound"],
  "eə":["short e","er sound"],
  "ɛə":["short e","er sound"],
  "ʊə":["short oo","er sound"],
  "ɪr":["short i","er sound"], "ɪɹ":["short i","er sound"],
  "er":["short e","er sound"],  "eɹ":["short e","er sound"],
  "ɛr":["short e","er sound"],  "ɛɹ":["short e","er sound"],
  "ʊr":["short oo","er sound"], "ʊɹ":["short oo","er sound"]
};

const STRESS_RE = /[ˈˌ]/g;

/* ===================== 正規化・抽出 ===================== */
/* BrE/旧表記→USへ吸収（表記ゆれ歓迎→最終US化） */
function sanitizeIPA(word, t){
  const w = (word||'').toLowerCase();
  let s = (t||'').normalize('NFC');

  // 基本ゆれ吸収
  s = s.replace(/ɹ/g,'r')    // ɹ → r
       .replace(/əʊ/g,'oʊ')  // BrE long o → US
       .replace(/ɒ/g,'ɑ')    // BrE short o → US
       .replace(/iə/g,'ɪr')  // near BrE → US rhotic
       .replace(/eə/g,'ɛr')  // wear/fairy BrE → US rhotic
       .replace(/ɛə/g,'ɛr')
       .replace(/ʊə/g,'ʊr')  // cure/tour BrE → US rhotic
       .replace(/ɜːr/g,'ɝː'); // er sound → US記号

  // are/care 系（æ/e/ɛ + r を強制 ar sound）
  if(w === 'are' || /(^|[^a-z])are$/.test(w)){
    s = s.replace(/(æ|e|ɛ)ː?r/g,'ɑr');
  }
  // æ + r → ɑr（辞書の癖）
  s = s.replace(/æː?r/g, m => m.includes('ː') ? 'ɑːr' : 'ɑr');

  // r結合の定形化
  s = s.replace(/ɑː?r/g, m => m.includes('ː') ? 'ɑːr' : 'ɑr')
       .replace(/ɔː?r/g, m => m.includes('ː') ? 'ɔːr' : 'ɔr');

  return s;
}

/* トークン抽出（長い→短い） */
const TOKEN_RE = new RegExp([
  'ɑːr','ɑr','ɔːr','ɔr',
  'iə','eə','ʊə','ɛə',
  'oʊ','əʊ','aɪ','aʊ','ɔɪ',
  'iː','uː','ɝː','ɝ','ɚ','ɜː',
  'æ','ɪ','i','ʊ','u','ɛ','ɑ','ɒ','ʌ','ə','ɔ',
  'ɪr','er','ɛr','ʊr'
].join('|'),'g');

function tokenize(word, ipaRaw){
  const core = sanitizeIPA(word, (ipaRaw||'').replace(STRESS_RE,''));
  return core.match(TOKEN_RE) || [];
}

function tokensToCategories(tokens){
  const out=[], seen=new Set();
  for(const t of tokens){
    const parts = SPECIAL_SPLIT[t] ?? [IPA_TO_CATEGORY[t]];
    for(const cat of parts){
      if(!cat || seen.has(cat)) continue;
      seen.add(cat);
      out.push({cat, sym: CATEGORY_LABELS[cat] || ''});
    }
  }
  return out;
}

function hiliteIPA(word, ipaRaw){
  if(!ipaRaw) return '—';
  const core = sanitizeIPA(word, ipaRaw);
  return core.replace(TOKEN_RE, (m)=>{
    if(m==='iə'||m==='eə'||m==='ʊə'||m==='ɛə'){
      return `<span class="vwl">${m[0]}</span><span class="vwl">ə</span>`;
    }
    if(m==='ɪr'||m==='er'||m==='ɛr'||m==='ʊr'){
      return `<span class="vwl">${m[0]}</span>r`;
    }
    return `<span class="vwl">${m}</span>`;
  });
}

/* ===================== 表示 ===================== */
function renderNormIPA(catObjs){
  const el = document.getElementById('ipaNorm');
  if(!catObjs.length){ el.innerHTML='—'; return; }
  el.innerHTML = '/' + catObjs.map(o=>`<span class="vwl">${o.sym}</span>`).join(' ') + '/';
}

function renderCats(catObjs){
  const keys=new Set(catObjs.map(o=>o.cat));
  const ordered=CATEGORY_ORDER.filter(c=>keys.has(c));
  const wrap=document.getElementById('catList');
  wrap.innerHTML='';
  for(const c of ordered){
    const sym=CATEGORY_LABELS[c]||'', vfile=CATEGORY_AUDIO[c]||'';
    const el=document.createElement('div');
    el.className='pill';
    el.innerHTML=`
      <div class="cat-head"><span>${c}</span><span class="muted">/${sym}/</span></div>
      <audio preload="none" controls ${vfile?`src="audio/vowels/${vfile}"`:''}></audio>
    `;
    wrap.appendChild(el);
  }
}

function renderExamples(catObjs){
  const keys=new Set(catObjs.map(o=>o.cat));
  const tgt=document.getElementById('examples');
  tgt.innerHTML='';
  for(const k of CATEGORY_ORDER){
    if(!keys.has(k)) continue;
    const sym=CATEGORY_LABELS[k]||'';
    const words=(CATEGORY_EXAMPLES[k]||[]);
    const box=document.createElement('div');
    box.className='pill';
    const chips=words.map(w=>`
      <div class="chip" data-w="${w}">
        <span>${w}</span>
        <audio preload="none" src="audio/words/${w}.mp3"></audio>
      </div>`).join('');
    box.innerHTML=`
      <div style="min-width:110px"><strong>${k}</strong> <span class="muted">/${sym}/</span></div>
      <div class="chips">${chips || '<span class="small muted">（例語未設定）</span>'}</div>
    `;
    tgt.appendChild(box);
  }
  tgt.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click',()=>{
      const au=ch.querySelector('audio');
      if(au){ au.currentTime=0; au.play().catch(()=>{}); }
    });
  });
}

function setSourceTags(list){
  const box=document.getElementById('srcTags');
  box.innerHTML='';
  list.forEach(t=>{
    const span=document.createElement('span');
    span.className='tag';
    span.textContent=t;
    box.appendChild(span);
  });
}

/* ===================== 3ソース取得 ===================== */
/* 0) 共通: USらしさ/変な表記 判定 */
function looksUS(ipa){ return /(oʊ|ɑ|ɝ|ɚ|[ɑɔɪɛʊ]r)/.test(ipa); }
function looksWeird(ipa){ return /(æ̈|aə|æ\s*iː)/.test(ipa); }

/* 1) Merriam-Webster (要APIキー。空ならスキップ) */
const MW_KEY = ""; // ← ここにキーがあれば使用（空ならMWは使わない）
async function fetchFromMW(word){
  if(!MW_KEY) return [];
  // Learner's Dictionary のほうが ipa フィールドが出やすい
  const url = `https://www.dictionaryapi.com/api/v3/references/learners/json/${encodeURIComponent(word)}?key=${MW_KEY}`;
  const r = await fetch(url);
  if(!r.ok) return [];
  const js = await r.json();
  const out=[];
  for(const e of js){
    const prs = e?.hwi?.prs;
    if(Array.isArray(prs)){
      for(const p of prs){
        if(p?.ipa){
          out.push({text:p.ipa, audio:(p?.sound?.audio ? `https://media.merriam-webster.com/audio/prons/en/us/mp3/${p.sound.audio[0]}/${p.sound.audio}.mp3` : ''), source:'MW'});
        }
      }
    }
  }
  return out;
}

/* 2) Wiktionary（MediaWiki API → HTML内の IPA span を抽出） */
async function fetchFromWiktionary(word){
  const url = `https://en.wiktionary.org/w/api.php?action=parse&page=${encodeURIComponent(word)}&prop=text&format=json&origin=*`;
  const r = await fetch(url);
  if(!r.ok) return [];
  const js = await r.json();
  const html = js?.parse?.text?.['*'] || '';
  if(!html) return [];

  // English セクション内の IPA span を緩く抽出
  const div = document.createElement('div');
  div.innerHTML = html;
  // 英語セクション以外も混ざることがあるため、English見出し以降を優先
  const spans=[...div.querySelectorAll('span.IPA')].map(s=>s.textContent.trim()).filter(Boolean);
  // /…/ の中身だけを拾う（複数ある場合は分割）
  const cands=[];
  spans.forEach(t=>{
    // 例: /ˈfɛəri/、[fæɹi] など混在 → /…/ を優先
    const m = t.match(/\/([^/]+)\//g) || [];
    if(m.length){ m.forEach(seg=>cands.push(seg.replace(/^\//,'').replace(/\/$/,''))); }
    else { cands.push(t); }
  });
  // ユニーク化
  return [...new Set(cands)].map(x=>({text:x, audio:'', source:'Wiktionary'}));
}

/* 3) dictionaryapi.dev */
async function fetchFromDictionaryApi(word){
  const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
  const r = await fetch(url);
  if(!r.ok) return [];
  const js = await r.json();
  const out=[];
  for(const entry of js){
    if(entry?.phonetics){
      for(const ph of entry.phonetics){
        if(ph?.text){ out.push({text:ph.text, audio:ph.audio||'', source:'dictionaryapi.dev'}); }
      }
    }
    if(entry?.phonetic){
      out.push({text:entry.phonetic, audio:'', source:'dictionaryapi.dev'});
    }
  }
  return out;
}

/* ==== 3ソース統合 → 正規化 → スコアリング採用 ==== */
function scoreCandidate(word, cand){
  // 正規化前後で評価
  const orig = cand.text || '';
  const txt  = sanitizeIPA(word, orig);
  let s = 0;

  // ソース重み（任意：MW > Wiktionary > dictionaryapi.dev）
  if(cand.source==='MW') s += 8;
  else if(cand.source==='Wiktionary') s += 5;
  else s += 2;

  // USらしさ（oʊ, ɑ, ɝ/ɚ, rhotic）
  if(/oʊ/.test(txt)) s += 3;
  if(/ɑ/.test(txt)) s += 2;
  if(/ɝ|ɚ/.test(txt)) s += 3;
  if(/[ɑɔɪɛʊ]r/.test(txt)) s += 2;

  // 旧/BrE表記が残っていたら減点（ただし後で sanitize 済みを表示する）
  if(/əʊ|ɒ/.test(orig)) s -= 3;
  if(/iə|eə|ɛə|ʊə/.test(orig)) s -= 4;

  // 明らかに変な表記は強減点
  if(looksWeird(orig)) s -= 8;

  // 音声があれば少し加点
  if(cand.audio) s += 1;

  return {score:s, text:txt, audio:cand.audio, source:cand.source, raw:orig};
}

async function fetchBestIPA(word){
  const all = [
    ...(await fetchFromMW(word)),
    ...(await fetchFromWiktionary(word)),
    ...(await fetchFromDictionaryApi(word))
  ];

  if(!all.length) throw new Error('No IPA candidates');

  // 重複除去（正規化前後で近似をまとめる）
  const uniqMap = new Map();
  for(const c of all){
    const key = sanitizeIPA(word, (c.text||'')).replace(/\s+/g,'');
    if(!key) continue;
    const prev = uniqMap.get(key);
    if(!prev || (c.audio && !prev.audio)){ uniqMap.set(key, c); }
  }
  const uniq = [...uniqMap.values()];
  if(!uniq.length) throw new Error('No usable IPA');

  // スコアリング
  const ranked = uniq.map(c=>scoreCandidate(word,c))
                     .sort((a,b)=>b.score-a.score);

  // 採用（最上位）
  const best = ranked[0];
  // 併せてソースタグを返す（上位3つまで表示）
  const topSrc = ranked.slice(0,3).map(r=>`${r.source}`);
  return { ipa: best.text, audio: best.audio, sources: topSrc };
}

/* ===================== 実行フロー ===================== */
async function run(){
  const q = document.getElementById('q').value.trim();
  if(!q) return;

  document.getElementById('yg').onclick = ()=>{
    window.open(`https://youglish.com/pronounce/${encodeURIComponent(q)}/english/us`,'_blank');
  };

  // Wiktionaryリンク
  document.getElementById('wikilink').innerHTML =
    `<a target="_blank" rel="noopener" href="https://en.wiktionary.org/wiki/${encodeURIComponent(q)}">Wiktionary</a>`;

  let ipa='', audioUrl='', srcs=[];
  try{
    const best = await fetchBestIPA(q);
    ipa = best.ipa || '';
    audioUrl = best.audio || '';
    srcs = best.sources || [];
  }catch(e){
    ipa = '';
    srcs = [];
  }

  // 採用IPA表示
  document.getElementById('ipaDict').innerHTML = ipa ? hiliteIPA(q, ipa) : '—';
  setSourceTags(srcs);

  // 音声再生
  const dictAudio = document.getElementById('dictAudio');
  document.getElementById('playDict').onclick = ()=>{
    if(!audioUrl){ alert('辞書音声はありません。'); return; }
    dictAudio.src = audioUrl;
    dictAudio.play().catch(()=>{});
  };

  // 正規化 → カテゴリ表示
  const catObjs = tokensToCategories(tokenize(q, ipa));

  // フォールバック（何も拾えなかった場合でも単母音は拾う）
  let cats = catObjs;
  if(!cats.length && ipa){
    const simple=(sanitizeIPA(q, ipa).match(/[æɪiʊuɛɑɒʌəɔ]/g)||[])
      .map(t=>IPA_TO_CATEGORY[t]).filter(Boolean);
    const seen=new Set();
    cats=simple.filter(c=>!seen.has(c) && seen.add(c))
               .map(c=>({cat:c, sym:CATEGORY_LABELS[c]}));
  }

  renderNormIPA(cats);
  renderCats(cats);
  renderExamples(cats);
}

/* ===================== 初期化 ===================== */
document.getElementById('btn').addEventListener('click', run);
document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') run(); });
document.addEventListener('DOMContentLoaded', ()=>{
  const params = new URL(location.href).searchParams;
  const w = params.get('w') || '';
  if(w){ document.getElementById('q').value = w; run(); }
});
</script>
</body>
</html>
