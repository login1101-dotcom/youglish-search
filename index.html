<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>母音抽出＋例語再生（USのみ・ローカル音源）</title>
<style>
  :root{
    --bg:#fafafa; --card:#fff; --ink:#222; --muted:#666;
    --accent:#0b74ff; --chip:#eef4ff; --red:#d9002b;
    --border:#e7e7e7;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans CJK JP",sans-serif}
  .wrap{max-width:900px;margin:32px auto;padding:0 16px}
  header{background:#fff;position:sticky;top:0;border-bottom:1px solid var(--border);z-index:10}
  h1{font-size:20px;margin:0;padding:14px 16px}
  .srch{display:flex;gap:8px;flex-wrap:wrap; margin:12px 0 24px}
  .srch input{flex:1;min-width:220px;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:16px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .sec{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 14px;margin:16px 0}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .ipa{font-family: "Noto Serif", "Times New Roman", serif; font-size:22px; letter-spacing:.5px}
  .ipa .vwl{color:var(--red);font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:var(--chip);border:1px solid #dfeaff}
  .chip .small{font-size:12px;color:var(--muted)}
  .cat-head{display:flex;align-items:center;gap:10px; font-weight:700}
  .cat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .pill{display:inline-grid;grid-auto-flow:column;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
  audio{height:32px; width: 100%}
  .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f7f7f7;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<header><h1>母音抽出＋例語再生（USのみ・ローカル音源）</h1></header>
<div class="wrap">
  <div class="srch">
    <input id="q" placeholder="単語（例: dog, camp, centrifuge, cure, near ...）" />
    <button class="btn primary" id="btn">検索</button>
    <button class="btn" id="yg">YouGlishで開く</button>
  </div>

  <!-- 辞書IPA + 正規化IPA 横並び -->
  <section class="sec" id="sec-ipa-norm">
    <div class="row" style="justify-content:space-between; align-items:flex-start">
      <div style="flex:1">
        <div class="muted">辞書（IPA）</div>
        <div id="ipaDict" class="ipa">—</div>
        <div class="muted src-links">
          ※ 取得元: dictionaryapi.dev（US優先選択）　
          <span id="wikilink"></span>
        </div>
        <button class="btn" id="playDict">辞書音声</button>
        <audio id="dictAudio" preload="none"></audio>
      </div>
      <div style="flex:1">
        <div class="muted">正規化発音記号（17母音 &amp; 赤色強調）</div>
        <div id="ipaNorm" class="ipa">—</div>
      </div>
    </div>
  </section>

  <section class="sec" id="sec-cats">
    <div class="muted">母音カテゴリ（この単語に含まれるもののみ）</div>
    <div id="catList" class="cat-grid"></div>
  </section>

  <section class="sec" id="sec-ex">
    <div class="muted">例単語（クリックでローカル音声再生）</div>
    <div id="examples" class="cat-grid"></div>
    <div class="muted" style="margin-top:8px">
      ローカル音声フォルダ: <span class="code">./audio/vowels/*.mp3</span> , <span class="code">./audio/words/*.mp3</span>
    </div>
  </section>
</div>

<script>
/* ========== カテゴリ定義 ========== */
const CATEGORY_ORDER = [
  "short i","long e","short e","short a","long a",
  "short oo","long u","short o","long o",
  "ar sound","or sound","er sound",
  "ai sound","au sound","oi sound",
  "schwa","schwa+r"
];

const CATEGORY_LABELS = {
  "short i": "ɪ",
  "long e": "iː",
  "short e": "ɛ",
  "short a": "æ",
  "long a": "eɪ",
  "short oo": "ʊ",
  "long u": "uː",
  "short o": "ɑ",
  "long o": "oʊ",
  "ar sound": "ɑːr",
  "or sound": "ɔːr",
  "er sound": "ɝː",
  "ai sound": "aɪ",
  "au sound": "aʊ",
  "oi sound": "ɔɪ",
  "schwa": "ə",
  "schwa+r": "ɚ"
};

const IPA_TO_CATEGORY = {
  "ɪ": "short i",
  "i": "long e", "iː": "long e",
  "ɛ": "short e",
  "æ": "short a",
  "eɪ": "long a",
  "ʊ": "short oo",
  "u": "long u", "uː": "long u",
  "ɑ": "short o",
  "ɒ": "short o",
  "ɔ": "short o",
  "oʊ": "long o", "əʊ": "long o",
  "ɑr": "ar sound", "ɑːr": "ar sound",
  "ɔr": "or sound", "ɔːr": "or sound",
  "ɝ": "er sound", "ɝː": "er sound", "ɚ": "er sound", "ɜː": "er sound",
  "aɪ": "ai sound",
  "aʊ": "au sound",
  "ɔɪ": "oi sound",
  "ə": "schwa",
  "eə": "short a",
  "ɛə": "short a"
};

const SPECIAL_SPLIT = {
  "iə": ["short i","er sound"],
  "ʊə": ["short oo","er sound"]
};

/* トークン抽出 */
const STRESS_RE = /[ˈˌ]/g;
const TOKEN_RE = new RegExp([
  'ɑːr','ɑr','ɔːr','ɔr',
  'iə','eə','ʊə','ɛə',
  'oʊ','əʊ','aɪ','aʊ','ɔɪ',
  'iː','uː','ɝ','ɚ','ɜː',
  'æ','ɪ','i','ʊ','u','ɛ','ɑ','ɒ','ʌ','ə','ɔ'
].join('|'),'g');

function tokenizeVowels(ipa){
  const core = ipa.normalize('NFC').replace(STRESS_RE,'');
  return core.match(TOKEN_RE) || [];
}

function tokensToCategories(tokens){
  const cats = [];
  const seen = new Set();
  for(const t of tokens){
    const arr = SPECIAL_SPLIT[t] || [IPA_TO_CATEGORY[t]];
    for(const cat of arr){
      if(cat && !seen.has(cat)){
        seen.add(cat);
        cats.push({cat, sym:CATEGORY_LABELS[cat]||''});
      }
    }
  }
  return cats;
}

function hiliteIPA(ipaRaw){
  const ipa = ipaRaw.normalize('NFC');
  return ipa.replace(TOKEN_RE, m => `<span class="vwl">${m}</span>`);
}

async function fetchIPA(word){
  const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('API error');
  const js = await r.json();

  const cands = [];
  for(const entry of js){
    if(entry && Array.isArray(entry.phonetics)){
      for(const ph of entry.phonetics){
        if(ph && ph.text){ cands.push({text: ph.text, audio: ph.audio||''}); }
      }
    }
    if(entry && entry.phonetic){ cands.push({text: entry.phonetic, audio:''}); }
  }
  if(!cands.length) throw new Error('IPA not found');

  const score = (p)=>{
    const t = (p.text||''), a = (p.audio||'');
    let s=0;
    if(/us/i.test(a)||/-us\.mp3$/i.test(a)) s+=6;
    if(a) s+=1;
    if(/oʊ/.test(t)) s+=2; if(/əʊ/.test(t)) s-=2;
    if(/ɑ/.test(t)) s+=1; if(/ɒ/.test(t)) s-=1;
    if(/(ɚ|ɝ)/.test(t)) s+=3;
    if(/(iə|eə|ʊə)/.test(t)) s-=1;
    return s;
  };
  cands.sort((a,b)=>score(b)-score(a));
  return {ipa: cands[0].text, audio: cands[0].audio};
}

function renderCats(cats){
  const uniqKeys = [...new Set(cats.map(c=>c.cat))];
  const wrap = document.getElementById('catList');
  wrap.innerHTML='';
  for(const k of uniqKeys){
    const v = {label:k, symbol:CATEGORY_LABELS[k]};
    const el=document.createElement('div');
    el.className='pill';
    el.innerHTML=`
      <div class="cat-head"><span>${k}</span><span class="muted">/${v.symbol}/</span></div>
      <audio preload="none" controls src="audio/vowels/${k}.mp3"></audio>
    `;
    wrap.appendChild(el);
  }
}

function renderExamples(cats){
  const keys=[...new Set(cats.map(c=>c.cat))];
  const tgt=document.getElementById('examples');
  tgt.innerHTML='';
  for(const k of keys){
    const box=document.createElement('div');
    box.className='pill';
    box.innerHTML=`<div><strong>${k}</strong> <span class="muted">/${CATEGORY_LABELS[k]}/</span></div>`;
    tgt.appendChild(box);
  }
}

function renderNormIPA(cats){
  if(!cats.length){
    document.getElementById('ipaNorm').innerHTML='—';
    return;
  }
  const seq=cats.map(c=>c.sym);
  document.getElementById('ipaNorm').innerHTML=hiliteIPA('/'+seq.join(' ')+'/');
}

async function run(){
  const q=document.getElementById('q').value.trim();
  if(!q) return;
  document.getElementById('yg').onclick=()=>{
    const u=`https://youglish.com/pronounce/${encodeURIComponent(q)}/english/us`;
    window.open(u,'_blank');
  };
  let ipa='', audioUrl='';
  try{ const {ipa:ipaRaw,audio}=await fetchIPA(q); ipa=ipaRaw||''; audioUrl=audio||''; }catch(e){ ipa=''; }
  document.getElementById('ipaDict').innerHTML=ipa?hiliteIPA(ipa):'—';
  const dictAudio=document.getElementById('dictAudio');
  document.getElementById('playDict').onclick=()=>{
    if(!audioUrl){ alert('辞書音声はありません。'); return; }
    dictAudio.src=audioUrl; dictAudio.play().catch(()=>{});
  };
  document.getElementById('wikilink').innerHTML=`<a target="_blank" rel="noopener" href="https://en.wiktionary.org/wiki/${encodeURIComponent(q)}">Wiktionary</a>`;
  const cats=ipa?tokensToCategories(tokenizeVowels(ipa)):[];
  renderNormIPA(cats);
  renderCats(cats);
  renderExamples(cats);
}

/* 初期化 */
document.getElementById('btn').addEventListener('click', run);
document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') run(); });
document.addEventListener('DOMContentLoaded', ()=>{
  const params=new URL(location.href).searchParams;
  const w=params.get('w')||'';
  if(w){ document.getElementById('q').value=w; run(); }
});
</script>
</body>
</html>
