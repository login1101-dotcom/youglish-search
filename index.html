<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>母音抽出＋例語再生（USのみ・ローカル音源）</title>
<style>
  :root{
    --fg:#222; --sub:#666; --pill:#f4f4f5; --accent:#d00;
    --bd:#e5e7eb; --bg:#fff; --muted:#9ca3af;
  }
  html,body{margin:0;padding:0;background:#fff;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px;}
  h1{font-size:22px;margin:8px 0 20px;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="text"]{flex:1;min-width:260px;padding:10px 12px;border:1px solid var(--bd);border-radius:10px;font-size:16px}
  button{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#fafafa;cursor:pointer}
  button:hover{background:#f0f0f0}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--bd);border-radius:999px;background:var(--pill);margin:6px 8px 0 0;font-size:14px}
  .sec{margin-top:18px}
  .sec h3{margin:0 0 6px;font-size:15px;color:var(--sub)}
  .ipa{font-size:22px;letter-spacing:1px}
  .ipa .v{color:var(--accent);font-weight:700}
  .small{color:var(--muted);font-size:12px;margin-left:6px}
  .grid{display:flex;flex-wrap:wrap;gap:8px}
  .pill{padding:8px 12px;border:1px solid var(--bd);border-radius:999px;background:#fff}
  .pill .ex{margin-left:6px;color:#2563eb;cursor:pointer}
  .pill .ex:hover{text-decoration:underline}
  .muted{color:var(--muted)}
  .hidden{display:none}
  a.link{color:#2563eb;text-decoration:none}
  a.link:hover{text-decoration:underline}
  .playbtn{padding:6px 10px;border-radius:999px;border:1px solid var(--bd);font-size:12px;background:#fff}
</style>
</head>
<body>
<div class="wrap">
  <h1>母音抽出＋例語再生（USのみ・ローカル音源）</h1>

  <div class="row">
    <input id="q" type="text" placeholder="単語を入力" />
    <button id="search">検索</button>
    <button id="yg">YouGlishで開く</button>
  </div>

  <div id="progress" class="small muted sec hidden">IPA取得中…</div>

  <div class="sec">
    <div class="row">
      <div class="pill">入力 <strong id="in_word" class="muted">-</strong></div>
    </div>
  </div>

  <div class="sec">
    <h3>辞書（IPA） <button id="speakDict" class="playbtn">▶︎ 辞書音声</button>
      <span class="small">※ 取得元: dictionaryapi.dev（US）</span>
    </h3>
    <div id="ipa" class="ipa muted">-</div>
    <div id="ipa_note" class="small muted"></div>
  </div>

  <div class="sec">
    <h3>発音記号（17母音に正規化＆赤色強調）</h3>
    <div id="ipa_norm" class="ipa muted">-</div>
  </div>

  <div class="sec">
    <h3>母音カテゴリ（この単語に含まれるもののみ）</h3>
    <div id="vowel_chips" class="grid"></div>
    <div id="no_vowel" class="small muted hidden">該当母音なし</div>
  </div>

  <div class="sec">
    <h3>例単語（クリックでローカル音声再生）</h3>
    <div id="examples" class="grid"></div>
  </div>

</div>

<script>
/** =========================
 * 設定：ローカル音源のベースパス
 * ========================= */
const AUDIO_BASE_VOWEL = "/youtube/フォニックス/母音mp3";   // 例: /youtube/フォニックス/母音mp3/short_a.mp3
const AUDIO_BASE_TTS   = "/youtube/フォニックス/TTS音声";   // 例: /youtube/フォニックス/TTS音声/cat.mp3

/** =========================
 * 17母音 定義（表示名 / IPA / 例語 / MP3名）
 * ========================= */
const VOWELS = [
  { id:'short_a',  name:'short a /æ/',   ipa:'æ',   mp3:'short_a.mp3',  ex:['camp','bath','fan'] },
  { id:'long_a',   name:'long a /eɪ/',   ipa:'eɪ',  mp3:'long_a.mp3',   ex:['fate','they','great'] },
  { id:'ar_sound', name:'ar sound /ɑːr/',ipa:'ɑːr',mp3:'ar_sound.mp3', ex:['car','art','mark'] },

  { id:'short_e',  name:'short e /e/',   ipa:'e',   mp3:'short_e.mp3',  ex:['let','get','egg'] },
  { id:'long_e',   name:'long e /iː/',   ipa:'iː',  mp3:'long_e.mp3',   ex:['fee','she','believe'] },
  { id:'er_sound', name:'er sound /ɝː/', ipa:'ɝː', mp3:'er_sound.mp3', ex:['bird','term','hurt'] },

  { id:'short_i',  name:'short i /ɪ/',   ipa:'ɪ',   mp3:'short_i.mp3',  ex:['fit','income','it'] },
  { id:'long_i',   name:'long i /aɪ/',   ipa:'aɪ',  mp3:'long_i.mp3',   ex:['eye','iron','idea'] },

  { id:'short_o',  name:'short o /ɑ/',   ipa:'ɑ',   mp3:'short_o.mp3',  ex:['hot','not','lock'] },
  { id:'long_oo',  name:'long oo /uː/',  ipa:'uː',  mp3:'long_oo.mp3',  ex:['too','loose','through'] },
  { id:'long_o',   name:'long o /oʊ/',   ipa:'oʊ',  mp3:'long_o.mp3',   ex:['note','no','slow'] },
  { id:'ow_sound', name:'ow sound /aʊ/', ipa:'aʊ',  mp3:'ow_sound.mp3',ex:['house','out','count'] },
  { id:'oi_sound', name:'oi sound /ɔɪ/', ipa:'ɔɪ',  mp3:'oi_sound.mp3', ex:['boy','joy','join'] },
  { id:'or_sound', name:'or sound /ɔːr/',ipa:'ɔːr',mp3:'or_sound.mp3', ex:['for','sort','storm'] },

  { id:'short_u',  name:'short u /ʌ/',   ipa:'ʌ',   mp3:'short_u.mp3',  ex:['but','fun','come'] },
  { id:'short_oo', name:'short oo /ʊ/',  ipa:'ʊ',   mp3:'short_oo.mp3', ex:['book','should','put'] },
  { id:'schwa',    name:'Schwa /ə/',     ipa:'ə',   mp3:'schwa.mp3',    ex:['about','support','pencil'] },
];

/** ================
 * 音声再生ヘルパ
 * ================ */
function play(url){
  const a = new Audio(url);
  a.play();
}

/** =========================================
 * IPA 抽出（dictionaryapi.dev / US 優先）
 * ========================================= */
async function fetchIPA(word){
  const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('fetch failed');
  const data = await r.json();
  // US 音声を優先して pronunciation を拾う
  let ipa = null, audio = null, source = 'dictionaryapi.dev';
  if(Array.isArray(data)){
    for(const entry of data){
      if(entry && Array.isArray(entry.phonetics)){
        // US 音源っぽいものを優先
        const usLike = entry.phonetics.find(p=>/us/i.test(p?.audio||''));
        const first   = entry.phonetics.find(p=>p.text) || {};
        const target  = usLike?.text ? usLike : first;
        ipa   = (target?.text || '').replaceAll('[','/').replaceAll(']','/'); // /.../ 形式へ
        audio = (usLike?.audio || entry.phonetics.find(p=>p.audio)?.audio || null);
        if(ipa) break;
      }
    }
  }
  return {ipa, audio, source};
}

/** =========================================
 * 17母音 正規化＆色付け
 * - 取得IPA内の一致部分を <span class="v">..</span> で赤表示
 * - その単語に含まれる母音カテゴリだけ抽出
 * ========================================= */
const sortByLengthDesc = arr => [...arr].sort((a,b)=>b.length-a.length);

function highlightAndCollect(ipaRaw){
  if(!ipaRaw) return {html:'-', found:[]};

  // 置換対象の“並び”を長い順にして貪欲一致
  const targets = sortByLengthDesc([
    'ɑːr','ɔːr','ɝː','iː','uː','aɪ','oʊ','aʊ','ɔɪ',
    'æ','eɪ','e','ɪ','ɑ','ʊ','oʊ','uː','ə'
  ]);

  // IPA → 17母音のラベルへひも付け（色付け＆収集用）
  const ipa2cat = {};
  for(const v of VOWELS){
    ipa2cat[v.ipa] = v.id;
  }

  let html = '';
  let rest = ipaRaw;
  let foundSet = new Set();

  // 1文字ずつ走査しつつ、先頭から最長一致を試す
  for(let i=0;i<rest.length;){
    let matched = '';
    for(const t of targets){
      if(rest.slice(i).startsWith(t)){
        matched = t;
        break;
      }
    }
    if(matched){
      const catId = ipa2cat[matched];
      if(catId){ foundSet.add(catId); }
      html += `<span class="v">${matched}</span>`;
      i += matched.length;
    }else{
      html += rest[i];
      i += 1;
    }
  }
  return {html, found:[...foundSet]};
}

/** =========================================
 * 表示レンダリング
 * ========================================= */
function renderVowelChips(foundIds){
  const box = document.getElementById('vowel_chips');
  const none = document.getElementById('no_vowel');
  box.innerHTML = '';
  if(!foundIds.length){
    none.classList.remove('hidden');
    return;
  }
  none.classList.add('hidden');

  for(const id of foundIds){
    const v = VOWELS.find(x=>x.id===id);
    if(!v) continue;

    // 母音ボタン（クリックで母音MP3）
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.innerHTML = `
      <strong>${v.name}</strong>
      <button class="playbtn" data-vowel="${id}">▶︎ 再生</button>
    `;
    chip.querySelector('button').addEventListener('click', ()=>{
      play(`${AUDIO_BASE_VOWEL}/${v.mp3}`);
    });
    box.appendChild(chip);
  }
}

function renderExamples(foundIds){
  const box = document.getElementById('examples');
  box.innerHTML = '';
  for(const id of foundIds){
    const v = VOWELS.find(x=>x.id===id);
    if(!v) continue;

    const pill = document.createElement('div');
    pill.className = 'pill';
    pill.innerHTML = `<strong>${v.name}</strong>`;

    for(const w of v.ex){
      const a = document.createElement('span');
      a.className = 'ex';
      a.textContent = w;
      a.title = 'クリックで音声再生';
      a.addEventListener('click', ()=> play(`${AUDIO_BASE_TTS}/${w}.mp3`));
      pill.appendChild(a);
    }
    box.appendChild(pill);
  }
}

/** =========================================
 * 検索ハンドラ
 * ========================================= */
async function doSearch(){
  const q = document.getElementById('q').value.trim();
  const inWord = document.getElementById('in_word');
  const ipaEl = document.getElementById('ipa');
  const ipaNote = document.getElementById('ipa_note');
  const normEl = document.getElementById('ipa_norm');
  const prog = document.getElementById('progress');
  const speakDictBtn = document.getElementById('speakDict');

  if(!q) return;

  inWord.textContent = q;
  ipaEl.textContent = '-';
  normEl.textContent = '-';
  ipaNote.textContent = '';
  prog.classList.remove('hidden');

  try{
    const {ipa, audio, source} = await fetchIPA(q);
    prog.classList.add('hidden');

    // IPA表示
    ipaEl.textContent = ipa || '(IPA未取得)';
    ipaEl.classList.toggle('muted', !ipa);

    // 辞書音声ボタン
    if(audio){
      speakDictBtn.disabled = false;
      speakDictBtn.onclick = ()=> play(audio);
    }else{
      speakDictBtn.disabled = true;
      speakDictBtn.onclick = null;
    }
    ipaNote.textContent = ipa ? `※ 取得元: ${source}` : '';

    // 正規化＆色付け
    const {html, found} = highlightAndCollect(ipa || '');
    normEl.innerHTML = html || '-';
    normEl.classList.toggle('muted', !ipa);

    // この単語に含まれる母音のみ表示
    renderVowelChips(found);
    renderExamples(found);

    // YouGlish
    document.getElementById('yg').onclick = ()=>{
      const url = `https://youglish.com/pronounce/${encodeURIComponent(q)}/english/us`;
      window.open(url, '_blank');
    };

  }catch(e){
    prog.classList.add('hidden');
    ipaEl.textContent = '(取得失敗)';
    normEl.textContent = '-';
    renderVowelChips([]);
    renderExamples([]);
    console.error(e);
  }
}

document.getElementById('search').addEventListener('click', doSearch);
document.getElementById('q').addEventListener('keydown', (e)=>{
  if(e.key==='Enter') doSearch();
});

// 初期フォーカス
document.getElementById('q').focus();
</script>
</body>
</html>
