<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>母音抽出＋例語再生（USのみ・ローカル音源）</title>
<style>
  :root { --fg:#111; --muted:#666; --brand:#0b79f7; --bg:#fff; --bd:#e7e7ea; }
  * { box-sizing: border-box; }
  body { margin:0; font:16px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; color:var(--fg); background:var(--bg); }
  header { position:sticky; top:0; backdrop-filter: blur(6px); background:#fffccf80; border-bottom:1px solid var(--bd); }
  .wrap { max-width:980px; margin:0 auto; padding:20px; }
  h1 { font-size:22px; margin:0; }
  .search { display:flex; gap:8px; margin-top:14px; }
  .search input { flex:1; padding:10px 12px; border:1px solid var(--bd); border-radius:10px; }
  .btn { padding:10px 14px; border-radius:10px; border:1px solid var(--bd); background:#fff; cursor:pointer; }
  .btn:hover { background:#fafafa; }
  .section { margin:18px 0; padding:16px; border:1px solid var(--bd); border-radius:14px; background:#fff; }
  .title { font-weight:700; margin-bottom:6px; }
  .note { color:var(--muted); font-size:13px; }
  .ipa { font-size:22px; letter-spacing:1px; }
  .ipa .red { color:#d81717; font-weight:700; }
  .chips { display:flex; flex-wrap:wrap; gap:8px; }
  .chip { display:inline-flex; align-items:center; gap:6px; border:1px solid var(--bd); padding:8px 10px; border-radius:999px; background:#fff; }
  .chip .mini { font-size:12px; color:#333; opacity:.7; }
  .ghost { opacity:.55 }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  a { color:var(--brand); text-decoration:none; }
  a:hover { text-decoration:underline; }
  .kbd { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; border:1px solid var(--bd); padding:2px 6px; border-radius:6px; font-size:12px; background:#fafafa; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>母音抽出＋例語再生（USのみ・ローカル音源）</h1>
    <div class="search">
      <input id="q" placeholder="単語を入力" autocomplete="off" />
      <button class="btn" id="btnSearch">検索</button>
      <button class="btn" id="btnYG">YouGlishで開く</button>
    </div>
  </div>
</header>

<main class="wrap" id="app">
  <div class="section">
    <div class="title">入力</div>
    <div id="inWord" class="chips"></div>
  </div>

  <div class="section">
    <div class="title">辞書（IPA）</div>
    <div class="row" style="gap:12px">
      <div id="dictIpa" class="ipa">—</div>
      <button class="btn" id="btnDictAudio">辞書音声</button>
      <a id="wikiLink" href="#" target="_blank">Wiktionary</a>
    </div>
    <div class="note">※ 取得元: dictionaryapi.dev（US）</div>
  </div>

  <div class="section">
    <div class="title">発音記号（17母音に正規化＆赤色強調）</div>
    <div id="normIpa" class="ipa">—</div>
    <div class="note">※ 取得IPAから母音コアを抽出し、指定17カテゴリにマッピングしています。</div>
  </div>

  <div class="section">
    <div class="title">母音カテゴリ（この単語に含まれるもののみ）</div>
    <div id="vowelChips" class="chips"></div>
  </div>

  <div class="section">
    <div class="title">例単語（クリックでローカル音声再生）</div>
    <div id="examples" class="chips"></div>
  </div>

  <div class="note">ローカル音声フォルダ:
    <span class="kbd">~/youglish-search/audio/vowels/*.mp3</span>,
    <span class="kbd">~/youglish-search/audio/words/*.mp3</span>
  </div>
</main>

<script>
/** -------------- 17母音マップ（正規化先） -----------------
 *  正規化先は以下の通り（ユーザ確定版）：
 *  1  short a  /æ/
 *  2  short e  /e/
 *  3  short i  /ɪ/
 *  4  short oo /ʊ/
 *  5  short u  /ʌ/
 *  6  long e   /iː/
 *  7  long a   /ɑː/
 *  8  long oo  /uː/
 *  9  aw sound /ɔː/
 * 10 long a   /eɪ/
 * 11 long o   /oʊ/
 * 12 long i   /aɪ/
 * 13 ow sound /aʊ/
 * 14 oi sound /ɔɪ/
 * 15 er sound /ɝː/
 * 16 ar sound /ɑːr/
 * 17 or sound /ɔːr/
 */
const VOWELS = [
  { id:'short_a',  name:'short a /æ/',    pat:/æ/g,     norm:'æ',   file:'short_a',  ex:['cat','camp','bath'] },
  { id:'short_e',  name:'short e /e/',    pat:/e(?!ɪ)/g, norm:'e',   file:'short_e',  ex:['bed','red','pen'] },
  { id:'short_i',  name:'short i /ɪ/',    pat:/ɪ/g,     norm:'ɪ',   file:'short_i',  ex:['sit','fish','milk'] },
  { id:'short_oo', name:'short oo /ʊ/',   pat:/ʊ/g,     norm:'ʊ',   file:'short_oo', ex:['book','good','put'] },
  { id:'short_u',  name:'short u /ʌ/',    pat:/ʌ/g,     norm:'ʌ',   file:'short_u',  ex:['but','sun','up'] },
  { id:'long_e',   name:'long e /iː/',    pat:/iː/g,    norm:'iː',  file:'long_e',   ex:['see','tree','green'] },
  { id:'long_a_f', name:'long a /ɑː/',    pat:/ɑː/g,    norm:'ɑː',  file:'long_a',   ex:['father','car'] },
  { id:'long_oo',  name:'long oo /uː/',   pat:/uː/g,    norm:'uː',  file:'long_oo',  ex:['too','loose','through'] },
  { id:'aw_sound', name:'aw sound /ɔː/',  pat:/ɔː/g,    norm:'ɔː',  file:'aw_sound', ex:['law','caught','dog'] },
  { id:'long_a',   name:'long a /eɪ/',    pat:/eɪ/g,    norm:'eɪ',  file:'long_a',   ex:['make','name'] },
  { id:'long_o',   name:'long o /oʊ/',    pat:/oʊ/g,    norm:'oʊ',  file:'long_o',   ex:['go','home'] },
  { id:'long_i',   name:'long i /aɪ/',    pat:/aɪ/g,    norm:'aɪ',  file:'long_i',   ex:['time','five'] },
  { id:'ow_sound', name:'ow sound /aʊ/',  pat:/aʊ/g,    norm:'aʊ',  file:'ow_sound', ex:['out','cow'] },
  { id:'oi_sound', name:'oi sound /ɔɪ/',  pat:/ɔɪ/g,    norm:'ɔɪ',  file:'oi_sound', ex:['boy','coin'] },
  { id:'er_sound', name:'er sound /ɝː/',  pat:/ɝː/g,    norm:'ɝː',  file:'er_sound', ex:['bird','her','hurt'] },
  { id:'ar_sound', name:'ar sound /ɑːr/', pat:/ɑːr/g,   norm:'ɑːr', file:'ar_sound', ex:['car','art'] },
  { id:'or_sound', name:'or sound /ɔːr/', pat:/ɔːr/g,   norm:'ɔːr', file:'or_sound', ex:['for','storm'] },
];

// 連続シーケンス優先のため、検出順序を並べ替え（長いパターン先）
const ORDERED = [
  'ɑːr','ɔːr','ɝː','iː','uː','eɪ','oʊ','aɪ','aʊ','ɔɪ','ɑː','ɔː','æ','e','ɪ','ʊ','ʌ'
];
const VOWEL_BY_SIGN = {};
for (const v of VOWELS) VOWEL_BY_SIGN[v.norm] = v;

// 要素
const $q = document.getElementById('q');
const $btnSearch = document.getElementById('btnSearch');
const $btnYG = document.getElementById('btnYG');
const $inWord = document.getElementById('inWord');
const $dictIpa = document.getElementById('dictIpa');
const $btnDictAudio = document.getElementById('btnDictAudio');
const $wikiLink = document.getElementById('wikiLink');
const $normIpa = document.getElementById('normIpa');
const $vowelChips = document.getElementById('vowelChips');
const $examples = document.getElementById('examples');

// 辞書APIから IPA を取る（US優先）
async function fetchIPA(word){
  const url = 'https://api.dictionaryapi.dev/api/v2/entries/en/' + encodeURIComponent(word);
  const res = await fetch(url);
  const json = await res.json();
  // US を優先して拾う
  let ipa = '';
  let audio = '';
  if (Array.isArray(json) && json.length) {
    const entry = json[0];
    if (Array.isArray(entry.phonetics)) {
      // US っぽいものを前に寄せる
      const ph = entry.phonetics.slice().sort((a,b)=>{
        const au = (a.audio||'').includes('-us') ? -1 : 0;
        const bu = (b.audio||'').includes('-us') ? -1 : 0;
        return au - bu;
      });
      for (const p of ph) {
        if (!ipa && p.text) ipa = p.text;
        if (!audio && p.audio) audio = p.audio;
        if (ipa && audio) break;
      }
    }
  }
  return {ipa, audio};
}

// IPA を 17母音で赤強調＋カテゴリ抽出
function normalizeAndHighlight(ipaRaw){
  if (!ipaRaw) return {html:'—', set:[], matchedIpa:''};

  let s = ipaRaw;
  let categories = new Map(); // key=norm, val=VOWEL
  let matchedIpa = ipaRaw;

  // 検出用：長いシーケンス優先で巡回
  for (const sign of ORDERED) {
    const v = VOWEL_BY_SIGN[sign];
    if (!v) continue;
    const re = new RegExp(v.pat.source, 'g');
    if (re.test(matchedIpa)) {
      matchedIpa = matchedIpa.replace(re, (m)=>`§§${m}§§`);
      categories.set(v.norm, v);
    }
  }
  // 強調
  let html = matchedIpa
    .replace(/§§/g, '§') // mark pairs
    .replace(/§([^§]+)§/g, (_,g1)=>`<span class="red">${g1}</span>`);

  return {html, set:[...categories.values()], matchedIpa};
}

// ローカル音声再生（vowel/words自動切替）
function playLocal(kind, key){
  // kind: 'vowel' | 'word'
  const base = kind === 'vowel' ? '/audio/vowels/' : '/audio/words/';
  const path = base + key.toLowerCase() + '.mp3';
  const a = new Audio(path);
  a.play().catch(()=>{
    alert('音声を再生できませんでした。ローカル音源はブラウザ制約でブロックされることがあります。');
  });
}

// UI生成
function chip(label, onClick, ghost=false){
  const el = document.createElement('button');
  el.className = 'chip' + (ghost?' ghost':'');
  el.type = 'button';
  el.textContent = label;
  if (onClick) el.onclick = onClick;
  return el;
}

async function run(){
  const w = $q.value.trim();
  if (!w) return;

  // 入力表示
  $inWord.innerHTML = '';
  $inWord.appendChild(chip(w));

  // YouGlish
  $btnYG.onclick = () => {
    const url = 'https://youglish.com/pronounce/'+encodeURIComponent(w)+'/english/us';
    window.open(url, '_blank');
  };

  // IPA 取得
  $dictIpa.textContent = '取得中…';
  const {ipa, audio} = await fetchIPA(w);
  $dictIpa.innerHTML = ipa ? `<span class="ipa">${ipa}</span>` : '—';
  $wikiLink.href = 'https://en.wiktionary.org/wiki/'+encodeURIComponent(w);
  // 辞書音声（ネット）
  $btnDictAudio.onclick = ()=>{
    if (!audio) return;
    const a = new Audio(audio);
    a.play();
  };

  // 正規化＆強調
  const {html, set} = normalizeAndHighlight(ipa);
  $normIpa.innerHTML = html || '—';

  // 母音カテゴリ（この単語に含まれるものだけ）
  $vowelChips.innerHTML = '';
  if (set.length === 0) {
    $vowelChips.textContent = '母音カテゴリは検出できませんでした。';
  } else {
    for (const v of set) {
      const row = document.createElement('div');
      row.className = 'row';
      row.style.marginBottom = '8px';

      const playBtn = chip('再生', ()=>playLocal('vowel', v.file));
      const tag = chip(v.name, null, true);
      row.appendChild(playBtn);
      row.appendChild(tag);
      $vowelChips.appendChild(row);
    }
  }

  // 例単語（カテゴリ毎に行を出す／この単語で検出されたカテゴリのみ）
  $examples.innerHTML = '';
  if (set.length) {
    for (const v of set) {
      // 見出し
      const head = chip(v.name, ()=>playLocal('vowel', v.file));
      $examples.appendChild(head);
      // 例語
      for (const ex of v.ex) {
        $examples.appendChild(chip(ex, ()=>playLocal('word', ex)));
      }
    }
  } else {
    $examples.textContent = '例単語は表示できません。';
  }
}

// 検索イベント
$btnSearch.onclick = run;
$q.addEventListener('keydown', e => { if (e.key === 'Enter') run(); });

// 初期値（開発確認用）
$q.value = '';
</script>
</body>
</html>
