<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>母音抽出＋例語再生（USのみ・ローカル音源）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap: 14px; }
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
         line-height:1.6;margin:24px;color:#111}
    h1{font-size:22px;margin:0 0 14px}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:var(--gap)}
    input[type=text]{flex:1; padding:10px 12px; font-size:16px; border:1px solid #bbb; border-radius:8px}
    button{padding:10px 14px; border:1px solid #bbb; background:#fff; border-radius:8px; cursor:pointer}
    button:hover{background:#f6f6f6}
    .card{border:1px solid #eee;border-radius:12px;padding:14px;margin:14px 0}
    .label{font-weight:700;margin-bottom:6px}
    .ipa{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
         background:#fafafa;border:1px solid #eee;border-radius:8px;padding:6px 10px;display:inline-block;min-width:120px}
    .highlight{color:#c40000;font-weight:700}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{border:1px solid #ddd;border-radius:999px;padding:8px 12px;background:#fff}
    audio{display:block;margin-top:6px;max-width:380px}
    .muted{color:#666;font-size:12px}
  </style>
</head>
<body>
  <h1>母音抽出＋例語再生（USのみ・ローカル音源）</h1>

  <div class="row">
    <input id="q" type="text" placeholder="単語を入力（例: cat, dog, bird, car, boy, centrifuge …）" />
    <button id="btn">検索</button>
    <button id="yg">YouGlishで開く</button>
  </div>

  <div class="card">
    <div class="label">辞書（IPA）</div>
    <div class="ipa" id="ipa_raw">—</div>
    <div class="muted">※ 取得元: dictionaryapi.dev（US）</div>
  </div>

  <div class="card">
    <div class="label">発音記号（17母音に正規化＆赤色強調）</div>
    <div class="ipa" id="ipa_norm">—</div>
    <div class="muted">※ 取得 IPA から母音コア（ɝ, ɔː, ɑ など）だけ抽出→指定 17 カテゴリへマップ。</div>
  </div>

  <div class="card">
    <div class="label">母音カテゴリ（この単語に含まれるもののみ）</div>
    <div id="cats" class="chips"></div>
  </div>

  <div class="card">
    <div class="label">例単語（クリックでローカル音声再生）</div>
    <div id="examples" class="chips"></div>
  </div>

  <div class="muted">ローカル音声フォルダ: ~/youglish-search/audio/vowels/*.mp3 , ~/youglish-search/audio/words/*.mp3</div>

<script>
/* ===================== ユーティリティ ===================== */
const stripStress = (s) => s.replace(/[ˈˌ]/g, '');            // 強勢のみ除去
const stripSlashesSpaces = (s) => s.replace(/[\/\s]/g, '');    // / と空白のみ除去

/* ===================== “dog は short o（ɑ）” の固定テーブル ===================== */
/* ここはご要望で明示固定。必要に応じて増やすだけ。 */
const WORD_OVERRIDE_CORE = {
  dog: 'ɑ',   // dog は必ず ɑ（short o）
};

/* ===================== 17母音抽出＆正規化 ===================== */
/* ★ 同じ正規表現を「辞書IPAのハイライト」と「コア抽出」の両方で利用 */
const VOWEL_CORE_RE = /(ɑːr|ɑr|ɝː|ɝ|oʊ|aɪ|aʊ|ɔɪ|ɔː|ɔ|ɑ|æ|e|iː|ɪ|uː|ʊ)/g;

function normalizeCoreTo17(core) {
  switch (core) {
    case 'ɑːr':
    case 'ɑr': return { cat: 'ar_sound',  symbol: 'ɑːr'  };   // car
    case 'ɝː':
    case 'ɝ':  return { cat: 'er_sound',  symbol: 'ɝː'  };   // bird
    case 'ɔː':
    case 'ɔ':  return { cat: 'aw_sound',  symbol: 'ɔ'    };   // caught, law
    case 'ɑ':  return { cat: 'short_o',   symbol: 'ɑ'    };   // hot, not, lock, dog(固定)
    case 'æ':  return { cat: 'short_a',   symbol: 'æ'    };   // cat
    case 'e':  return { cat: 'short_e',   symbol: 'e'    };   // bed
    case 'ɪ':  return { cat: 'short_i',   symbol: 'ɪ'    };   // sit
    case 'iː': return { cat: 'long_e',    symbol: 'iː'   };   // see
    case 'ʊ':  return { cat: 'short_oo',  symbol: 'ʊ'    };   // book
    case 'uː': return { cat: 'long_oo',   symbol: 'uː'   };   // food
    case 'oʊ': return { cat: 'long_o',    symbol: 'oʊ'   };   // go
    case 'aɪ': return { cat: 'long_i',    symbol: 'aɪ'   };   // time
    case 'aʊ': return { cat: 'ow_sound',  symbol: 'aʊ'   };   // now
    case 'ɔɪ': return { cat: 'oi_sound',  symbol: 'ɔɪ'   };   // boy
    default:   return null;
  }
}

function extractCoresFromIPA(ipaRaw) {
  const core = stripSlashesSpaces(stripStress(ipaRaw)).normalize('NFC');
  return core.match(VOWEL_CORE_RE) || [];
}

/* ===================== IPAハイライト（辞書IPAの母音だけ赤） ===================== */
function highlightVowelsInIPA(rawIPA) {
  if (!rawIPA) return '—';
  // そのまま置換（強勢記号やスラッシュは残す／母音部分だけ <span>）
  return rawIPA.replace(VOWEL_CORE_RE, m => `<span class="highlight">${m}</span>`);
}

/* ===================== 表示メタ（例単語と母音デモ音） ===================== */
/* ★ dog を aw_sound 側から外し、short_o 側は hot/not/lock に統一 */
const VOWEL_META = {
  short_a : { audio:'audio/vowels/short_a.mp3',  examples:['cat','camp','bath'] },
  short_o : { audio:'audio/vowels/short_o.mp3',  examples:['hot','not','lock'] },
  short_e : { audio:'audio/vowels/short_e.mp3',  examples:['bed','pen','red'] },
  short_i : { audio:'audio/vowels/short_i.mp3',  examples:['sit','hit','fish'] },
  long_e  : { audio:'audio/vowels/long_e.mp3',   examples:['see','green','believe'] },
  short_oo: { audio:'audio/vowels/short_oo.mp3', examples:['book','good','put'] },
  long_oo : { audio:'audio/vowels/long_oo.mp3',  examples:['food','loose','through'] },
  long_o  : { audio:'audio/vowels/long_o.mp3',   examples:['go','home','open'] },
  long_i  : { audio:'audio/vowels/long_i.mp3',   examples:['time','find','like'] },
  ow_sound: { audio:'audio/vowels/ow_sound.mp3', examples:['now','out','down'] },
  oi_sound: { audio:'audio/vowels/oi_sound.mp3', examples:['boy','coin','voice'] },
  er_sound: { audio:'audio/vowels/er_sound.mp3', examples:['bird','hurt','learn'] },
  aw_sound: { audio:'audio/vowels/aw_sound.mp3', examples:['caught','law','saw'] },
  ar_sound: { audio:'audio/vowels/ar_sound.mp3', examples:['car','art','mark'] },
};

/* ===================== メイン処理 ===================== */
async function doSearch() {
  const q = document.getElementById('q').value.trim();
  if (!q) return;

  document.getElementById('yg').onclick = () => {
    const url = `https://youglish.com/pronounce/${encodeURIComponent(q)}/english/us`;
    window.open(url, '_blank');
  };

  // 1) IPA 取得
  let ipa = '';
  try {
    const r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(q)}`);
    const j = await r.json();
    if (Array.isArray(j) && j[0]?.phonetics?.length) {
      const phon = j[0].phonetics;
      const cand = phon.find(p => (p.audio||'').includes('-us')) || phon.find(p=>p.text) || phon[0];
      ipa = cand?.text || '';
    }
  } catch(e) { console.error(e); }

  // 1-a) 「辞書IPA」表示（母音だけ赤）
  document.getElementById('ipa_raw').innerHTML = highlightVowelsInIPA(ipa);

  // 2) 抽出 → 正規化（必要なら単語 override を適用）
  let cores = extractCoresFromIPA(ipa);
  const ovCore = WORD_OVERRIDE_CORE[q.toLowerCase()];
  if (ovCore) { cores = [ovCore]; } // ★ dog は必ず ɑ（short o）

  const norm = cores.map(c => normalizeCoreTo17(c)).filter(Boolean);

  // 3) 赤字記号表示（正規化後）
  const normHTML = norm.length
    ? norm.map(n => `<span class="highlight">${n.symbol}</span>`).join(' ')
    : '（未分類）';
  document.getElementById('ipa_norm').innerHTML = normHTML;

  // 4) カテゴリごとの母音デモ音
  const cats = [...new Set(norm.map(n => n.cat))];
  const catsWrap = document.getElementById('cats');
  catsWrap.innerHTML = '';
  cats.forEach(cat => {
    const meta = VOWEL_META[cat];
    if (!meta) return;
    const el = document.createElement('div');
    el.className = 'chip';
    el.innerHTML = `
      <div style="font-weight:700;margin-bottom:4px">${cat.replace('_',' ')}</div>
      <audio controls preload="metadata" src="${meta.audio}"></audio>
    `;
    catsWrap.appendChild(el);
  });

  // 5) 例単語（クリックで words/*.mp3 再生）
  const exWrap = document.getElementById('examples');
  exWrap.innerHTML = '';
  cats.forEach(cat => {
    const meta = VOWEL_META[cat];
    if (!meta) return;
    meta.examples.forEach(w => {
      const item = document.createElement('div');
      item.className = 'chip';
      item.innerHTML = `
        <div style="font-weight:700">${w}</div>
        <audio controls preload="metadata" src="audio/words/${w}.mp3"></audio>
      `;
      exWrap.appendChild(item);
    });
  });
}

/* ===================== 起動時 ===================== */
document.getElementById('btn').addEventListener('click', doSearch);
document.getElementById('q').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') doSearch(); });
document.getElementById('q').value = 'dog';   // 動作確認用
doSearch();
</script>
</body>
</html>
